#!/bin/bash
#
# cmdlog - Audit log viewer for clawdbot commands
#
# Location: ~/Projects/cmdlog/cmdlog

export TZ=$(cat /etc/timezone 2>/dev/null || echo "America/Bogota")

# Show help
show_help() {
    cat << 'EOF'
cmdlog - View clawdbot command audit logs

USAGE:
    cmdlog [N]              Show last N commands (default: 1000)
    cmdlog --all            Show all of today's commands (slow)
    cmdlog --recent [N]     Last N commands (default: 200)
    cmdlog --grep PATTERN   Search recent commands for pattern
    cmdlog --live           Real-time watch
    cmdlog --raw [N]        Raw audit format

ALIASES:
    cmdlog-recent = cmdlog --recent
    cmdlog-today  = cmdlog --today
    cmdlog-grep   = cmdlog --grep
    cmdlog-live   = cmdlog --live
EOF
}

# Format a single line: timestamp | command
format_one() {
    local line="$1"
    local ts_epoch ts cmd a0 arg decoded
    
    ts_epoch=$(echo "$line" | grep -oP 'msg=audit\(\K[0-9]+(?=\.)')
    [ -z "$ts_epoch" ] && return
    ts=$(date -d "@$ts_epoch" "+%m/%d %H:%M" 2>/dev/null)
    [ -z "$ts" ] && return
    
    a0=$(echo "$line" | grep -oP 'a0="\K[^"]+' | head -1)
    [ -z "$a0" ] && return
    
    # Clean path
    a0=${a0##*/}
    
    # Build command
    cmd="$a0"
    for i in 1 2 3 4 5; do
        arg=$(echo "$line" | grep -oP "a$i=\"\K[^\"]+" | head -1)
        [ -z "$arg" ] && continue
        # Decode hex
        [[ "$arg" =~ ^[0-9a-f]+$ ]] && [ ${#arg} -gt 4 ] && \
            arg=$(echo "$arg" | xxd -r -p 2>/dev/null | tr -d '\0')
        cmd="$cmd $arg"
    done
    
    # Trim and check
    cmd=$(echo "$cmd" | sed 's/^ *//; s/ *$//')
    [ ${#cmd} -lt 2 ] && return
    
    # Filter utilities
    local first="${cmd%% *}"
    case "$first" in
        grep|tail|head|awk|sed|cat|tee|sort|date|sudo|ip|locale|xxd|printf|seq|comm|tr|uniq|tac|wc) return ;;
    esac
    [[ "$cmd" == *cmdlog* ]] && return
    [ "$cmd" = "bash" ] || [ "$cmd" = "sh" ] || [ "$cmd" = "bash -c" ] || [ "$cmd" = "bash -lc" ] || [ "$cmd" = "sh -c" ] && return
    
    echo "$ts | $cmd"
}

# Read and process N lines
process_n() {
    local n="${1:-1000}"
    
    sudo ausearch -k clawdbot_exec -ts today -r 2>/dev/null | \
    grep "^type=EXECVE" | \
    tail -n "$((n * 2))" | \
    while read line; do
        format_one "$line"
    done | tail -n "$n"
}

# Main commands
cmd_main() {
    echo "Recent commands (last ${1:-1000}):"
    echo "=================================="
    process_n "${1:-1000}"
}

cmd_all() {
    echo "All of today's commands:"
    echo "========================"
    sudo ausearch -k clawdbot_exec -ts today -r 2>/dev/null | \
    grep "^type=EXECVE" | \
    while read line; do format_one "$line"; done
}

cmd_recent() { cmd_main "${1:-200}"; }

cmd_grep() {
    local pat="${1:-}"
    [ -z "$pat" ] && { echo "Usage: cmdlog --grep PATTERN"; exit 1; }
    
    echo "Searching for: $pat (last 1000 entries)"
    echo "======================================="
    
    # Get formatted output, then grep
    process_n 1000 | grep -i "$pat"
}

cmd_live() {
    local tmp=$(mktemp)
    trap "rm -f $tmp" EXIT
    
    echo "Watching... (Ctrl+C to stop)"
    sudo ausearch -k clawdbot_exec -ts recent -r 2>/dev/null | grep "^type=EXECVE" > "$tmp"
    
    while true; do
        sudo ausearch -k clawdbot_exec -ts recent -r 2>/dev/null | grep "^type=EXECVE" | \
        comm -13 <(sort "$tmp") - | while read line; do
            format_one "$line"
        done
        sudo ausearch -k clawdbot_exec -ts recent -r 2>/dev/null | grep "^type=EXECVE" > "$tmp"
        sleep 2
    done
}

cmd_raw() {
    local n="${1:-}"
    if [ -n "$n" ]; then
        sudo ausearch -k clawdbot_exec -ts today -r 2>/dev/null | grep "^type=EXECVE" | tail -n "$n"
    else
        sudo ausearch -k clawdbot_exec -ts today -r 2>/dev/null | grep "^type=EXECVE"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

case "${1:-}" in
    --help|-h) show_help ;;
    --all) cmd_all ;;
    --recent) cmd_recent "$2" ;;
    --grep) cmd_grep "$2" ;;
    --live) cmd_live ;;
    --raw) cmd_raw "$2" ;;
    "") cmd_main 1000 ;;
    [0-9]*) cmd_main "$1" ;;
    *) echo "Unknown: $1"; exit 1 ;;
esac
